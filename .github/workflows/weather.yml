name: Weather pipeline

on:
  schedule:
    # morning.py — 00:00, 06:00, 12:00, 18:00 UTC
    - cron: "0 0 * * *"
    - cron: "0 6 * * *"
    - cron: "0 12 * * *"
    - cron: "0 18 * * *"

    # night.py — 02:00, 14:00 UTC
    - cron: "0 2 * * *"
    - cron: "0 14 * * *"

  workflow_dispatch:
    inputs:
      mode:
        description: "Which job to run"
        required: true
        default: "night"
        type: choice
        options: [night, morning]

      debug_dump:
        description: "Enable debug prints (0/1)"
        required: false
        default: "0"
        type: choice
        options: ["0", "1"]

      debug_source:
        description: "Exact source_id to debug (e.g. OME_GFS)"
        required: false
        default: ""
        type: string

      debug_station:
        description: "Exact station_id to debug (e.g. KMDW)"
        required: false
        default: ""
        type: string

jobs:
  morning:
    name: Run morning.py
    if: >-
      ${{
        (github.event_name == 'schedule' &&
          (github.event.schedule == '0 0 * * *' ||
           github.event.schedule == '0 6 * * *' ||
           github.event.schedule == '0 12 * * *' ||
           github.event.schedule == '0 18 * * *'))
        ||
        (github.event_name == 'workflow_dispatch' &&
          github.event.inputs.mode == 'morning')
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      WEATHER_DB_URL: ${{ secrets.WEATHER_DB_URL }}
      TOMORROW_API_KEY: ${{ secrets.TOMORROW_API_KEY }}
      WEATHERAPI_KEY: ${{ secrets.WEATHERAPI_KEY }}
      VISUALCROSSING_KEY: ${{ secrets.VISUALCROSSING_KEY }}

      # Debug envs (only populated for workflow_dispatch runs)
      DEBUG_DUMP: ${{ github.event.inputs.debug_dump }}
      DEBUG_SOURCE: ${{ github.event.inputs.debug_source }}
      DEBUG_STATION: ${{ github.event.inputs.debug_station }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run morning
        run: python morning.py

  night:
    name: Run night.py
    if: >-
      ${{
        (github.event_name == 'schedule' &&
          (github.event.schedule == '0 2 * * *' ||
           github.event.schedule == '0 14 * * *'))
        ||
        (github.event_name == 'workflow_dispatch' &&
          github.event.inputs.mode == 'night')
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      WEATHER_DB_URL: ${{ secrets.WEATHER_DB_URL }}
      TOMORROW_API_KEY: ${{ secrets.TOMORROW_API_KEY }}
      WEATHERAPI_KEY: ${{ secrets.WEATHERAPI_KEY }}
      VISUALCROSSING_KEY: ${{ secrets.VISUALCROSSING_KEY }}

      # Debug envs (only populated for workflow_dispatch runs)
      DEBUG_DUMP: ${{ github.event.inputs.debug_dump }}
      DEBUG_SOURCE: ${{ github.event.inputs.debug_source }}
      DEBUG_STATION: ${{ github.event.inputs.debug_station }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run night
        run: python night.py
